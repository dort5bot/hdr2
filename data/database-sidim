# data/database.db (SQLite veritabanı şeması)
-- Bu dosya SQLite veritabanının şemasını gösterir
-- Gerçek bir .db dosyası oluşturmak için aşağıdaki SQL komutlarını çalıştırın

-- mails tablosu
CREATE TABLE IF NOT EXISTS mails (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    message_id TEXT UNIQUE NOT NULL,
    from_email TEXT NOT NULL,
    subject TEXT,
    file_path TEXT NOT NULL,
    status TEXT NOT NULL CHECK(status IN ('pending', 'processing', 'success', 'failed')),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    processed_at TIMESTAMP NULL,
    error_message TEXT NULL
);

-- logs tablosu
CREATE TABLE IF NOT EXISTS logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    level TEXT NOT NULL CHECK(level IN ('DEBUG', 'INFO', 'WARNING', 'ERROR', 'CRITICAL')),
    message TEXT NOT NULL,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    module TEXT NULL,
    context TEXT NULL
);

-- processed_files tablosu
CREATE TABLE IF NOT EXISTS processed_files (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    original_filename TEXT NOT NULL,
    processed_filename TEXT NOT NULL,
    group_no TEXT NOT NULL,
    file_size INTEGER NOT NULL,
    row_count INTEGER NOT NULL,
    processed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    status TEXT NOT NULL CHECK(status IN ('success', 'failed')),
    error_message TEXT NULL
);

-- email_stats tablosu
CREATE TABLE IF NOT EXISTS email_stats (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    date DATE NOT NULL,
    total_emails INTEGER DEFAULT 0,
    processed_emails INTEGER DEFAULT 0,
    failed_emails INTEGER DEFAULT 0,
    total_files INTEGER DEFAULT 0,
    UNIQUE(date)
);

-- source_emails tablosu
CREATE TABLE IF NOT EXISTS source_emails (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    email TEXT UNIQUE NOT NULL,
    description TEXT,
    added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- process_history tablosu
CREATE TABLE IF NOT EXISTS process_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    status TEXT,
    details TEXT,
    mail_count INTEGER
);

-- Indexler
CREATE INDEX IF NOT EXISTS idx_mails_status ON mails(status);
CREATE INDEX IF NOT EXISTS idx_mails_created_at ON mails(created_at);
CREATE INDEX IF NOT EXISTS idx_mails_message_id ON mails(message_id);
CREATE INDEX IF NOT EXISTS idx_logs_timestamp ON logs(timestamp);
CREATE INDEX IF NOT EXISTS idx_logs_level ON logs(level);
CREATE INDEX IF NOT EXISTS idx_processed_files_group ON processed_files(group_no);
CREATE INDEX IF NOT EXISTS idx_processed_files_date ON processed_files(processed_at);
